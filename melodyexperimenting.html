<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.8.25/Tone.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0/es6/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.0.0"></script>
</head>

<body>
    <button onclick="play()">Play</button>
    <script>
        let cmajor = [60, 62, 64, 65, 67, 69, 71, 72, 74, 76, 77, 79, 81, 83, 84];
        let cminor = [60, 62, 63, 65, 67, 68, 70, 72, 74, 75, 77, 79, 80, 82, 84];

        let startTime = 0;
        let endTime;
        let totalTime;
        let seedSequence = {
            totalQuantizedSteps: 25,
            quantizationInfo: {
                // the higher the number the "faster" it is, basically how many the base length is divided into
                stepsPerQuarter: 4
            },
            notes: []
        }

        // these variables values will be determined by emotional content of each tweet
        let minNoteLength;
        let maxNoteLength;
        let keyTransposition;

        // for hard coding, this will be linked to emotion score from tweets
        let emotionsArray = ["excited", "indifferent"];
        // Initialize the model.
        music_rnn = new mm.MusicRNN('https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv');
        music_rnn.initialize();

        rnnPlayer = new mm.Player();

        function getNotes(transposition) {
            for (let i = 0; i < 10; i++) {
                let newNoteLength = returnNoteLength();
                let note = { pitch: returnNote() + transposition, startTime: startTime, endTime: startTime + newNoteLength }
                seedSequence.notes.push(note);
                startTime += newNoteLength;
            }
            console.log(seedSequence)
        }

        function returnNote() {
            let randomNumber = Math.floor(Math.random() * (cmajor.length - 1));
            return cmajor[randomNumber];
        }

        function returnNoteLength() {
            let noteLength = Math.random() * (maxNoteLength - minNoteLength) + minNoteLength;
            return noteLength
        }

        function getEmotionMelodies() {
            for (let i = 0; i < emotionsArray.length; i++) {
                if (emotionsArray[i] === "excited") {
                    minNoteLength = 0.1;
                    maxNoteLength = 0.5;
                    keyTransposition = -8;
                }
                if (emotionsArray[i] === "indifferent") {
                    minNoteLength = 0.5;
                    maxNoteLength = 1.5;
                    keyTransposition = 0;
                }
                getNotes(keyTransposition)
            }
        }

        getEmotionMelodies()

        function play() {
            console.log("play function")
            // if (rnnPlayer.isPlaying()) {
            //     rnnPlayer.stop();
            //     return;
            // }

            // the generated melody is USUALLY in the key of the chord passed, sometimes in a closely related key like the 5th or relative major/minor
            // seems to accept most chord notation, ex. cm CM Cm F#m 
            // args: input sequence, how many steps into the future, temperature/how random, chord structure
            music_rnn.continueSequence(seedSequence, 100, 1.5, ['Cm'])
                .then((sample) => {
                    let qns = mm.sequences.quantizeNoteSequence(seedSequence, 4);
                    console.log("qns", qns)
                    console.log("sample", sample);
                    sample.notes.forEach(note => {
                        note.quantizedStartStep += qns.notes[qns.notes.length-1].quantizedEndStep
                        note.quantizedEndStep += qns.notes[qns.notes.length-1].quantizedEndStep
                    })
                    let allNotes = qns.notes.concat(sample.notes);
                    sample.notes = allNotes;
                    console.log(sample)
                    rnnPlayer.start(sample);
                    console.log("better be playing!!");
                })
        }

    </script>
</body>

</html>